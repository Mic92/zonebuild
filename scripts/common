build_path_check() 
{
	! [ -d "${OUT_PATH}" ] && mkdir -p "${OUT_PATH}" 
	return 0
}


build_path_check

#[1]:config file  [2]:zone name [3]:zone file
cu_add_master_zone()
{
    if [ -f "${1}" ]; then
            cat ${1} | grep -q \"${2}\" && return 1
    else
    	echo "# Include in /etc/named.conf:
#
#include \"${1}\";
#
" > ${1}
    fi
    
	echo "zone \"${2}\" {
        type master;
        also-notify {
                ${MASTERS}
                };
        file \"`echo ${3} | sed -r 's/^[.]{1,2}//'`\";
        };
	" >> ${1}
	return 0
}

#[1]:config file  [2]:zone name [3]:forwarders
cu_add_forwarders_zone(){
	if [ -f "${1}" ]; then
            cat ${1} | grep -q \"${2}\" && return 1
    else
    	echo "# Include in /etc/named.conf:
#
#include \"${1}\";
#
" > ${1}
    fi
    
	echo "zone \"${2}\" {
        type forward;
        fowarders {
                ${3}
                };        
        };
	" >> ${1}
	return 0
}

#[1]:config file  [2]:zone name [3]: file
cu_add_hint_zone(){
	if [ -f "${1}" ]; then
            cat ${1} | grep -q \"${2}\" && return 1
    else
    	echo "# Include in /etc/named.conf:
#
#include \"${1}\";
#
" > ${1}
    fi
    
	echo "zone \"${2}\" {
        type hint;
        file \"`echo ${3} | sed -r 's/^[.]{1,2}//'`\";
	" >> ${1}
	return 0
}


#[1]: nameserver [2]: zone
generate_soa()
{
		echo '$TTL' ${DEFAULT_TTL}
        echo "${2}. IN SOA ${1}. ${CONTACT_EMAIL}. (`date +%s` 14400 3600 1209600 7200)"
}

#[1]: registry file [2]:zone name [3]: options [4]: ttl
generate_forward_zone ()
{
		rm -f /tmp/zb.common.$$.tmp
		
		echo "${3}" | egrep -q 'nons' || {
        		sed -n "s/^nserver:[ \t]\+\([^ \t]\+\)$/${2}. ${4} IN NS \1./p" $1 >> /tmp/zb.common.$$.tmp
        		sed -n "s/^nserver:[ \t]\+\([^ \t]\+\)[ \t].*$/${2}. ${4} IN NS \1./p" $1 >> /tmp/zb.common.$$.tmp
        }  
		
		echo "${3}" | egrep -q 'noglue' || {
                sed -n "s/^nserver:[ \t]\+\([^ \t]\+\)[ \t]\+\([0-9]\+\.[0-9.]\+\)[ \t]*$/\1. ${4} IN A \2/p" $1 >> /tmp/zb.common.$$.tmp
                sed -n "s/^nserver:[ \t]\+\([^ \t]\+\)[ \t]\+\([0-9a-fA-F]*:[0-9a-fA-F:]\+\)[ \t]*$/\1. ${4} IN AAAA \2/p" $1 >> /tmp/zb.common.$$.tmp
        }
		      
        
        cat /tmp/zb.common.$$.tmp | uniq
}


#[1]: zone [2]: server [3]: flags 
axfr_zone()
{
	dig @${2} ${3} ${1} AXFR
	return $?
}

mtn_io_all ()
{
  [ -z "$1" ] && echo "missing cmd" && return 2
  r=0
  for i in "${SYNC_SERVERS[@]}"; do
        mtn $1 $i $2; r=$[r+$?]
  done
  return $r
}

# [1]: directory
mtn_pull() {
	old_dir=${PWD}
	cd ${1}
	
	mtn_io_all pull &&
		mtn merge &&
			mtn update || return 2
			
	cd ${old_dir}
}

run_subnettr(){
	save_path=${PWD}
	cd ${REGISTRY_PATH}
	cd ..
	grep nserver data/inet6num/* | sed -E 's_:nserver:[\ \t]+_,_' | sed -E 's_[\ \t]+_,_' | sed s/_/,/ | sed s_data/inet6num/__ > ${OUT_PATH}/ipv6/inet6.txt
	cd  ${OUT_PATH}/ipv6
    ./subnettr.py
    cd ${save_path}
	return $?
}

#[1]: server [2]: branch
git_pull()
{
	${GIT} pull git://${1}/nixnodes/zonebuild ${2}
	return $?
}

print_usage_and_exit() 
{
	echo "${USAGE_STR}"
	exit 2
}